#!/bin/bash - 
if [ ! -z "$1" ] ; then
    IP=`aws ec2 describe-instances --region eu-central-1 --profile rm | grep PublicIp | tail -1 | sed -e 's/.*PublicIp":[^\"]*"\([^"]*\).*/\1/g'`
    (cat /etc/hosts | grep -v remote-dev-server-riskmatch; echo "$IP remote-dev-server-riskmatch") > /etc/hosts
    ssh ubuntu@$IP -R 40000:localhost:22 -i ~/.ssh/remote-dev-server.pem -t "(cat /etc/hosts | grep -v remote-dev-server-riskmatch; echo '$IP remote-dev-server-riskmatch') > /etc/hosts; riskmatch"
else
    cd ~/K/risk
    TMUX_SESSION="dev_riskmatch$1"
    tmux attach -t $TMUX_SESSION || tmux new-session -d -s $TMUX_SESSION -n 'vim' -c "$PWD" \;\
         new-window -n 'master-site' -c "$PWD/backend/master-site" \;\
         new-window -n 'master-worker' -c "$PWD/backend/master-worker" \;\
         new-window -n 'broker-site' -c "$PWD/backend/broker-site" \;\
         new-window -n 'broker-worker' -c "$PWD/backend/broker-worker" \;\
         new-window -n 'carrier-site' -c "$PWD/backend/carrier-site" \;\
         new-window -n 'carrier-worker' -c "$PWD/backend/carrier-worker" \;\
         new-window -n 'carriercalc-worker' -c "$PWD/backend/carriercalc-worker" \;\
         new-window -n 'mysql' \;\
         new-window -n 'elasticsearch' -c "$PWD/backend/carriercalc-worker" \;\
         new-window -n 'logs' -c "$PWD/backend/carriercalc-worker" \;\
         send-keys -t $TMUX_SESSION:0 'vim' C-m \;\
         send-keys -t $TMUX_SESSION:8 'mysql -u root' C-m \;\
         send-keys -t $TMUX_SESSION:9 'ES_MAX_MEM=512m elasticsearch' C-m \;\
         select-window -t "$TMUX_SESSION:0" \;\
         attach
fi
